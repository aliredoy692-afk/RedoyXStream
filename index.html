<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer"> <title>REDOYFLIX - Hybrid</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --red: #ff0000; --dark: #111; }
        body { background: var(--dark); color: white; font-family: 'Roboto', sans-serif; margin: 0; padding-bottom: 50px; }
        
        /* Status Bar */
        #statusBar { background: #333; color: gold; text-align: center; padding: 5px; font-size: 11px; font-weight: bold; position: sticky; top: 0; z-index: 2000; }
        
        header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #000; }
        .logo { font-family: 'Oswald'; font-size: 26px; color: var(--red); letter-spacing: 1px; }
        
        /* Grid */
        .section { padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
        .card { cursor: pointer; position: relative; }
        .card img { width: 100%; height: 160px; object-fit: cover; border-radius: 5px; background: #222; }
        .title { font-size: 12px; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #ddd; }

        /* Player Modal */
        #playerModal { display: none; position: fixed; inset: 0; background: black; z-index: 5000; flex-direction: column; }
        .p-header { padding: 10px; background: #222; display: flex; justify-content: space-between; align-items: center; }
        
        /* Video Container */
        .video-wrapper { width: 100%; aspect-ratio: 16/9; background: black; position: relative; }
        iframe, video { width: 100%; height: 100%; border: none; }
        
        .controls { padding: 15px; flex: 1; overflow-y: auto; }
        .ep-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; margin-top: 10px; }
        .ep-btn { background: #222; padding: 10px; text-align: center; border-radius: 4px; cursor: pointer; border: 1px solid #333; font-size: 12px; }
        .active-ep { background: var(--red); color: white; border-color: var(--red); }
        
        /* Server Buttons */
        .srv-list { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; }
        .srv-btn { padding: 5px 10px; background: #333; border: 1px solid #555; border-radius: 4px; font-size: 11px; white-space: nowrap; cursor: pointer; }
    </style>
</head>
<body>

    <div id="statusBar">üöÄ System Checking...</div>

    <header>
        <div class="logo" onclick="location.reload()">REDOYFLIX</div>
        <i class="fas fa-sync" onclick="location.reload()"></i>
    </header>

    <div class="section">
        <h3 id="mainTitle">üî• Trending Anime</h3>
        <div class="grid" id="animeGrid"></div>
    </div>

    <div id="playerModal">
        <div class="p-header">
            <span id="pTitle" style="font-size:14px; overflow:hidden; white-space:nowrap; max-width:80%;">Playing...</span>
            <button onclick="closePlayer()" style="background:red; color:white; border:none; padding:5px 12px; border-radius:3px;">X</button>
        </div>
        
        <div class="video-wrapper">
            <iframe id="iframePlayer" style="display:none;" allowfullscreen></iframe>
            <video id="directPlayer" controls playsinline style="display:none;"></video>
        </div>

        <div class="controls">
            <p id="playerMsg" style="color:#aaa; font-size:11px; margin-bottom:5px;">Select an episode:</p>
            <div class="srv-list" id="srvButtons" style="display:none;"></div>
            <div class="ep-grid" id="epList"></div>
        </div>
    </div>

    <script>
        // 1. ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (Zoro is usually best)
        const SERVERS = [
            { name: 'Zoro', type: 'direct', url: 'https://consumet-api-latest-qhhs.onrender.com/anime/zoro' },
            { name: 'Gogo', type: 'iframe', url: 'https://consumet-api-latest-qhhs.onrender.com/anime/gogoanime' },
            { name: 'Pahe', type: 'direct', url: 'https://consumet-api-latest-qhhs.onrender.com/anime/animepahe' }
        ];

        let activeServer = null;

        function updateStatus(msg) { document.getElementById('statusBar').innerText = msg; }

        // 2. ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï‡¶æ‡¶∞
        async function init() {
            for (const s of SERVERS) {
                try {
                    updateStatus(`Connecting to ${s.name}...`);
                    const res = await fetch(`${s.url}/top-airing`);
                    if(!res.ok) throw new Error();
                    const data = await res.json();
                    
                    if(data.results.length > 0) {
                        activeServer = s;
                        updateStatus(`‚úÖ Connected to ${s.name}!`);
                        renderGrid(data.results);
                        setTimeout(() => document.getElementById('statusBar').style.display = 'none', 3000);
                        return;
                    }
                } catch(e) {}
            }
            updateStatus("‚ùå All Servers Busy. Please Wait & Refresh.");
        }

        function renderGrid(list) {
            const grid = document.getElementById('animeGrid');
            grid.innerHTML = '';
            list.forEach(item => {
                grid.innerHTML += `
                    <div class="card" onclick="openPlayer('${item.id}')">
                        <img src="${item.image}" loading="lazy" onerror="this.src='https://via.placeholder.com/150'">
                        <div class="title">${item.title}</div>
                    </div>`;
            });
        }

        // 3. ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶ì‡¶™‡ßá‡¶®‡¶æ‡¶∞
        async function openPlayer(id) {
            document.getElementById('playerModal').style.display = 'flex';
            document.getElementById('pTitle').innerText = "Loading Info...";
            document.getElementById('epList').innerHTML = '<p>Fetching Episodes...</p>';
            
            try {
                const res = await fetch(`${activeServer.url}/info/${id}`);
                const data = await res.json();
                document.getElementById('pTitle').innerText = data.title;
                
                const epList = document.getElementById('epList');
                epList.innerHTML = '';
                
                // ‡¶è‡¶™‡¶ø‡¶∏‡ßã‡¶° ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
                let episodes = data.episodes;
                if(!episodes) throw new Error("No eps");
                if(activeServer.name !== 'Zoro') episodes = episodes.reverse(); // Zoro already sorted

                episodes.forEach(ep => {
                    const btn = document.createElement('div');
                    btn.className = 'ep-btn';
                    btn.innerText = ep.number;
                    btn.onclick = () => playEp(ep.id, btn);
                    epList.appendChild(btn);
                });

                // ‡ßß‡¶Æ ‡¶è‡¶™‡¶ø‡¶∏‡ßã‡¶° ‡¶Ö‡¶ü‡ßã ‡¶™‡ßç‡¶≤‡ßá
                if(episodes.length) playEp(episodes[0].id, epList.firstChild);

            } catch(e) { alert("Error loading details!"); closePlayer(); }
        }

        // 4. ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶Ü‡¶∏‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ú‡¶ø‡¶ï)
        async function playEp(epId, btn) {
            document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active-ep'));
            if(btn) btn.classList.add('active-ep');
            
            const iframe = document.getElementById('iframePlayer');
            const video = document.getElementById('directPlayer');
            const srvBtns = document.getElementById('srvButtons');

            // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
            iframe.style.display = 'none'; iframe.src = '';
            video.style.display = 'none'; video.pause();
            srvBtns.style.display = 'none';

            // ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶ö‡ßá‡¶ï: ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶ï‡¶ø Gogo ‡¶®‡¶æ‡¶ï‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø?
            if (activeServer.type === 'iframe') {
                // Gogoanime ‡¶π‡¶≤‡ßá ‡¶Æ‡ßÅ‡¶≠‡¶ø ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ö‡¶≤‡¶¨‡ßá
                iframe.style.display = 'block';
                iframe.src = `https://embtaku.pro/streaming.php?id=${epId}`;
                document.getElementById('playerMsg').innerText = "Playing via Movie Box";
            } else {
                // Zoro/Pahe ‡¶π‡¶≤‡ßá ‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶ö‡¶≤‡¶¨‡ßá
                video.style.display = 'block';
                document.getElementById('playerMsg').innerText = "Loading Direct Stream...";
                
                try {
                    const res = await fetch(`${activeServer.url}/watch/${epId}`);
                    const data = await res.json();
                    
                    // ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶¨‡¶æ‡¶ü‡¶® (Server 1, Server 2)
                    srvBtns.style.display = 'flex';
                    srvBtns.innerHTML = '';
                    
                    data.sources.forEach((src, idx) => {
                        const b = document.createElement('div');
                        b.className = 'srv-btn';
                        b.innerText = `Server ${idx+1} (${src.quality || 'auto'})`;
                        b.onclick = () => loadVideoStream(src.url);
                        srvBtns.appendChild(b);
                    });

                    // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ
                    const defaultSrc = data.sources.find(s => s.quality === 'default' || s.quality === 'auto') || data.sources[0];
                    if(defaultSrc) loadVideoStream(defaultSrc.url);

                } catch(e) { alert("Stream failed. Try another anime."); }
            }
        }

        function loadVideoStream(url) {
            const video = document.getElementById('directPlayer');
            if(Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
            } else {
                video.src = url;
            }
            video.play();
        }

        function closePlayer() {
            document.getElementById('playerModal').style.display = 'none';
            document.getElementById('iframePlayer').src = "";
            document.getElementById('directPlayer').pause();
        }

        init();
    </script>
</body>
</html>
