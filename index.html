<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedoyXStream - AniLab</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FFD700; --bg: #0F0F0F; --text: #fff; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; padding-bottom: 70px; }
        
        /* SERVER STATUS MSG */
        #serverStatus { 
            background: #222; color: orange; text-align: center; padding: 10px; font-size: 12px;
            border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 200;
        }

        /* HEADER */
        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(15,15,15,0.95); }
        .logo { font-weight: 800; font-size: 22px; color: var(--primary); }
        
        /* SLIDER */
        .hero-container { position: relative; width: 100%; height: 260px; overflow: hidden; margin-bottom: 20px; }
        .slide { position: absolute; inset: 0; opacity: 0; transition: opacity 1s ease; background-size: cover; background-position: center; }
        .slide.active { opacity: 1; }
        .slide-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(to top, black, transparent); }
        
        /* SECTIONS (AniLab Style) */
        .section { margin-bottom: 25px; padding-left: 15px; }
        .sec-head { display: flex; justify-content: space-between; padding-right: 15px; margin-bottom: 10px; align-items: center; }
        .sec-title { border-left: 3px solid var(--primary); padding-left: 10px; font-weight: bold; }
        .see-all { font-size: 12px; color: var(--primary); cursor: pointer; }
        
        .row { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .row::-webkit-scrollbar { display: none; }
        
        .card { min-width: 110px; width: 110px; position: relative; cursor: pointer; }
        .card img { width: 100%; height: 160px; object-fit: cover; border-radius: 8px; background: #222; }
        .card-title { font-size: 11px; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #ccc; }
        
        /* PLAYER & SEARCH OVERLAYS */
        .overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 5000; flex-direction: column; overflow-y: auto; }
        .search-bar { width: 90%; margin: 15px auto; padding: 12px; background: #222; border: 1px solid #333; color: white; display: block; border-radius: 8px; }
        
        /* LOADING ANIMATION */
        .loader { width: 100%; height: 160px; background: #222; border-radius: 8px; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { opacity: 0.5; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="serverStatus">Connecting to Server...</div>

    <div class="header">
        <div class="logo">REDOY<span>X</span></div>
        <i class="fas fa-search" style="font-size: 20px;" onclick="document.getElementById('searchUI').style.display='block'"></i>
    </div>

    <div class="hero-container" id="hero"></div>

    <div class="section">
        <div class="sec-head"><div class="sec-title">üÜï New Releases</div><div class="see-all">See All</div></div>
        <div class="row" id="recentRow"><div class="loader"></div><div class="loader"></div></div>
    </div>

    <div class="section">
        <div class="sec-head"><div class="sec-title">üî• Trending Now</div><div class="see-all">See All</div></div>
        <div class="row" id="trendingRow"><div class="loader"></div><div class="loader"></div></div>
    </div>

    <div class="section">
        <div class="sec-head"><div class="sec-title">‚öîÔ∏è Action</div><div class="see-all">See All</div></div>
        <div class="row" id="actionRow"><div class="loader"></div><div class="loader"></div></div>
    </div>
    
    <div class="section">
        <div class="sec-head"><div class="sec-title">üëª Horror</div><div class="see-all">See All</div></div>
        <div class="row" id="horrorRow"><div class="loader"></div><div class="loader"></div></div>
    </div>

    <div id="searchUI" class="overlay" style="padding-top:20px;">
        <div style="display:flex; justify-content:space-between; padding:0 20px;">
            <h2>Search</h2>
            <i class="fas fa-times" style="font-size:24px;" onclick="this.parentElement.parentElement.style.display='none'"></i>
        </div>
        <input type="text" class="search-bar" id="q" placeholder="Type anime name..." onchange="doSearch()">
        <div class="row" id="sGrid" style="flex-wrap:wrap; justify-content:center; padding-bottom:50px;"></div>
    </div>

    <div id="playerUI" class="overlay">
        <div style="padding:15px; display:flex; gap:15px; align-items:center; background:#111;">
            <i class="fas fa-arrow-left" onclick="closePlayer()"></i>
            <span id="pTitle" style="font-weight:bold; color:gold;">Now Playing</span>
        </div>
        <div style="width:100%; aspect-ratio:16/9; background:black;">
            <video id="vid" controls autoplay style="width:100%; height:100%;"></video>
        </div>
        <div id="epList" style="display:grid; grid-template-columns:repeat(5,1fr); gap:10px; padding:15px;"></div>
    </div>

    <script>
        const API = 'https://api-consumet-org-d9jc.onrender.com/anime/gogoanime';
        
        async function checkServer() {
            try {
                // Check if server is awake
                const res = await fetch(`${API}/recent-episodes`);
                if(!res.ok) throw new Error("Server sleeping");
                document.getElementById('serverStatus').innerText = "‚úÖ Server is Live & Connected!";
                document.getElementById('serverStatus').style.color = "lightgreen";
                setTimeout(() => document.getElementById('serverStatus').style.display='none', 3000);
                return true;
            } catch(e) {
                document.getElementById('serverStatus').innerHTML = "‚ö†Ô∏è Server is waking up... Please wait 30s & <a href='javascript:location.reload()' style='color:white;'>REFRESH</a>";
                return false;
            }
        }

        async function init() {
            // First check connection
            const isAwake = await checkServer();
            if(!isAwake) return; // Stop if server is sleeping

            loadSection('recent-episodes', 'recentRow');
            
            // Slider & Trending
            const top = await fetch(`${API}/top-airing`).then(r=>r.json());
            buildSlider(top.results.slice(0,5));
            renderCards(top.results, 'trendingRow');

            loadSection('action', 'actionRow');
            loadSection('horror', 'horrorRow');
        }

        async function loadSection(endpoint, id) {
            const res = await fetch(`${API}/${endpoint}`);
            const data = await res.json();
            renderCards(data.results, id);
        }

        function renderCards(list, id) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            list.forEach(item => {
                el.innerHTML += `
                <div class="card" onclick="openPlayer('${item.id}')">
                    <img src="${item.image}" loading="lazy">
                    <div class="card-title">${item.title}</div>
                </div>`;
            });
        }

        function buildSlider(list) {
            const hero = document.getElementById('hero');
            list.forEach((item, i) => {
                hero.innerHTML += `
                <div class="slide ${i==0?'active':''}" style="background-image:url('${item.image}')">
                    <div class="slide-content"><h3>${item.title}</h3></div>
                </div>`;
            });
            let idx = 0;
            setInterval(() => {
                const s = document.querySelectorAll('.slide');
                s[idx].classList.remove('active');
                idx = (idx+1)%s.length;
                s[idx].classList.add('active');
            }, 3000);
        }

        async function openPlayer(id) {
            document.getElementById('playerUI').style.display = 'flex';
            const res = await fetch(`${API}/info/${id}`);
            const data = await res.json();
            document.getElementById('pTitle').innerText = data.title;
            const grid = document.getElementById('epList');
            grid.innerHTML = '';
            data.episodes.reverse().forEach(ep => {
                grid.innerHTML += `<div style="background:#333; padding:10px; text-align:center; border-radius:5px;" onclick="play('${ep.id}')">${ep.number}</div>`;
            });
            if(data.episodes.length) play(data.episodes[0].id);
        }

        async function play(epId) {
            const res = await fetch(`${API}/watch/${epId}`);
            const data = await res.json();
            const src = data.sources.find(s=>s.quality==='default').url;
            const video = document.getElementById('vid');
            if(Hls.isSupported()){
                const hls = new Hls();
                hls.loadSource(src);
                hls.attachMedia(video);
            } else video.src = src;
        }

        async function doSearch() {
            const q = document.getElementById('q').value;
            const res = await fetch(`${API}/${q}`);
            const data = await res.json();
            renderCards(data.results, 'sGrid');
        }

        function closePlayer(){
            document.getElementById('playerUI').style.display = 'none';
            document.getElementById('vid').pause();
        }

        init();
    </script>
</body>
</html>
