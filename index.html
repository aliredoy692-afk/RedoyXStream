<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Streaming World Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00f2ff; --bg: #050505; --card: #111; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; padding-bottom: 80px; }

        /* NAVBAR & LOGIN */
        .navbar { 
            padding: 15px; background: rgba(0,0,0,0.95); position: sticky; top: 0; z-index: 1000; 
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222;
        }
        .logo { font-size: 18px; font-weight: 900; color: white; text-transform: uppercase; text-shadow: 0 0 10px var(--primary); }
        .logo span { color: var(--primary); }
        
        .user-area { display: flex; align-items: center; gap: 10px; }
        .login-btn { background: #ea4335; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .user-profile { display: none; align-items: center; gap: 8px; font-size: 12px; font-weight: bold; }
        .user-avatar { width: 30px; height: 30px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold; }

        .search-container { margin: 10px 15px; background: #222; padding: 8px 15px; border-radius: 25px; border: 1px solid #333; display: flex; align-items: center; }
        .search-box { background: transparent; border: none; color: white; width: 100%; outline: none; font-size: 14px; }

        /* HERO SLIDER */
        .hero-slider { position: relative; width: 100%; height: 260px; overflow: hidden; margin-bottom: 20px; }
        .slide { position: absolute; inset: 0; background-size: cover; background-position: center; opacity: 0; transition: opacity 1s; }
        .slide.active { opacity: 1; }
        .slide-content { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, var(--bg), transparent); padding: 20px; }
        .slide-title { font-size: 22px; font-weight: bold; text-shadow: 2px 2px 5px black; margin-bottom: 10px; }
        .watch-btn { background: var(--primary); color: black; border: none; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 20px; }

        /* SCHEDULE & HISTORY */
        .special-row { display: flex; gap: 10px; overflow-x: auto; padding: 0 15px 15px; scrollbar-width: none; }
        .sched-card { min-width: 140px; background: #1a1a1a; padding: 10px; border-radius: 8px; border-left: 3px solid var(--primary); }
        .sched-date { font-size: 10px; color: var(--primary); margin-bottom: 5px; font-weight: bold; }
        .sched-title { font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* CATEGORIES */
        .section { margin-bottom: 30px; }
        .sec-head { display: flex; justify-content: space-between; padding: 0 15px 10px; align-items: center; }
        .sec-title { font-size: 16px; font-weight: bold; border-left: 4px solid var(--primary); padding-left: 10px; color: var(--primary); }
        .see-all { font-size: 11px; color: #888; cursor: pointer; font-weight: bold; letter-spacing: 1px; }
        
        .row { display: flex; gap: 10px; overflow-x: auto; padding: 0 15px; scrollbar-width: none; min-height: 180px; }
        .card { min-width: 115px; position: relative; cursor: pointer; transition: 0.2s; }
        .card:active { transform: scale(0.95); }
        .card img { width: 100%; height: 165px; object-fit: cover; border-radius: 6px; }
        
        /* SEE ALL VIEW */
        #seeAllView { display: none; padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .loading-text { text-align: center; color: #666; margin-top: 20px; font-size: 12px; }

        /* PLAYER MODAL */
        #playerModal { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 5000; flex-direction: column; }
        .video-box { flex: 1; position: relative; width: 100%; height: 100%; }
        
        #stickerBar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: #050505; z-index: 6002; display: flex; align-items: center; justify-content: center;
            border-bottom: 2px solid var(--primary); font-weight: bold; color: var(--primary);
            text-transform: uppercase; letter-spacing: 2px; font-size: 12px;
        }
        .back-btn { position: absolute; top: 15px; left: 15px; color: white; font-size: 24px; z-index: 6003; cursor: pointer; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 50%; }
        iframe { width: 100%; height: 100%; border: none; background: #000; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo">Stream<span>Pro</span></div>
        <div class="user-area">
            <button id="loginBtn" class="login-btn" onclick="googleLogin()">
                <i class="fab fa-google"></i> Login
            </button>
            <div id="userProfile" class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
                <i class="fas fa-sign-out-alt" onclick="logout()" style="margin-left:5px; cursor:pointer; color:#666;"></i>
            </div>
        </div>
    </div>

    <div class="search-container">
        <i class="fas fa-search" style="color:#666; margin-right:10px;"></i>
        <input type="text" id="searchInput" class="search-box" placeholder="Search Anime (e.g. Naruto)..." onkeyup="if(event.key==='Enter') doSearch()">
    </div>

    <div id="homeView">
        <div class="hero-slider" id="heroSlider"></div>

        <div id="historySection" class="section" style="display:none;">
            <div class="sec-head"><div class="sec-title">ðŸ•’ Continue Watching</div></div>
            <div class="row" id="historyRow"></div>
        </div>

        <div class="section">
            <div class="sec-head"><div class="sec-title">ðŸ“… Airing Schedule (Today)</div></div>
            <div class="special-row" id="scheduleRow">
                <div style="padding:10px; color:#666; font-size:12px;">Loading schedule...</div>
            </div>
        </div>

        <div id="categoriesArea"></div>
    </div>

    <div id="seeAllView">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <h2 id="viewTitle" style="margin:0; font-size:16px; color:var(--primary); font-weight:bold;">All Anime</h2>
            <button onclick="goHome()" style="background:#222; color:white; border:none; padding:6px 15px; border-radius:20px; font-size:12px;">BACK</button>
        </div>
        <div class="grid" id="infiniteGrid"></div>
        <div id="loadingIndicator" class="loading-text">Scrolling for more...</div>
    </div>

    <div id="playerModal">
        <div class="video-box">
            <i class="fas fa-arrow-left back-btn" onclick="closePlayer()"></i>
            <div id="stickerBar">USER PLEASE SCROLL</div>
            <iframe id="iframe" src="" allowfullscreen sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
        </div>
    </div>

    <script>
        const API_KEY = '15d2ea6d0dc1d476efbca3eba2b9bbfb';
        const BASE = 'https://api.themoviedb.org/3';
        let currentUrl = '';
        let currentPage = 1;
        let isLoading = false;

        // ðŸ”¥ 10 SOLID CATEGORIES
        const genres = [
            { title: "ðŸ”¥ Top Airing Now", url: `&sort_by=popularity.desc&air_date.gte=2024-01-01` },
            { title: "ðŸ†• New Releases", url: `&first_air_date.gte=2024-01-01&sort_by=first_air_date.desc` },
            { title: "ðŸ’Ž Ultra Rare Classics", url: `&sort_by=vote_average.desc&vote_count.gte=300` },
            { title: "âš”ï¸ Shonen Action", url: `&with_genres=28,16&with_keywords=6075` }, // Action + Anime
            { title: "ðŸ§™ Isekai & Magic", url: `&with_genres=10765&with_keywords=209936` }, // Fantasy + Isekai tag
            { title: "â¤ï¸ Romance & School", url: `&with_genres=10749,16` },
            { title: "ðŸ‘» Horror & Thriller", url: `&with_genres=9648,16` },
            { title: "ðŸ¤– Sci-Fi & Mecha", url: `&with_genres=878,16` },
            { title: "ðŸŽ­ Slice of Life", url: `&with_genres=10751,16` },
            { title: "ðŸ©¸ Dark Fantasy", url: `&with_keywords=9951` }
        ];

        // --- AUTH SIMULATION ---
        function checkLogin() {
            const user = localStorage.getItem('sw_user');
            if(user) {
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('userProfile').style.display = 'flex';
                document.getElementById('userName').innerText = user;
                document.getElementById('userAvatar').innerText = user.charAt(0).toUpperCase();
            }
        }
        function googleLogin() {
            const name = prompt("Enter your Gmail name for simulation:");
            if(name) {
                localStorage.setItem('sw_user', name);
                checkLogin();
            }
        }
        function logout() {
            localStorage.removeItem('sw_user');
            location.reload();
        }

        // --- WATCH HISTORY ---
        function addToHistory(anime) {
            let hist = JSON.parse(localStorage.getItem('sw_history') || '[]');
            // Remove duplicate if exists
            hist = hist.filter(h => h.id !== anime.id);
            // Add to front
            hist.unshift(anime);
            // Limit to 10
            if(hist.length > 10) hist.pop();
            localStorage.setItem('sw_history', JSON.stringify(hist));
            loadHistory();
        }

        function loadHistory() {
            const hist = JSON.parse(localStorage.getItem('sw_history') || '[]');
            const row = document.getElementById('historyRow');
            const sec = document.getElementById('historySection');
            
            if(hist.length > 0) {
                sec.style.display = 'block';
                row.innerHTML = '';
                hist.forEach(a => {
                    row.innerHTML += `<div class="card" onclick="openAniWatch('${cleanTitle(a.name)}', ${a.id}, '${a.poster_path}')">
                                        <img src="https://image.tmdb.org/t/p/w300${a.poster_path}">
                                      </div>`;
                });
            }
        }

        // --- SCHEDULE ---
        async function loadSchedule() {
            // Get Anime airing today (using discovery with air_date)
            const today = new Date().toISOString().split('T')[0];
            const res = await fetch(`${BASE}/discover/tv?api_key=${API_KEY}&with_genres=16&with_original_language=ja&air_date.gte=${today}&air_date.lte=${today}&sort_by=popularity.desc`);
            const data = await res.json();
            const row = document.getElementById('scheduleRow');
            
            if(data.results.length > 0) {
                row.innerHTML = '';
                data.results.forEach(a => {
                    row.innerHTML += `
                        <div class="sched-card" onclick="openAniWatch('${cleanTitle(a.name)}', ${a.id}, '${a.poster_path}')">
                            <div class="sched-date">TODAY</div>
                            <div class="sched-title">${a.name}</div>
                        </div>`;
                });
            } else {
                row.innerHTML = '<div style="padding:10px; color:#666;">No major releases today.</div>';
            }
        }

        // --- MAIN LOADER ---
        // ðŸ”¥ Strict Filter Function (No Movies/Drama)
        function strictAnimeFilter(list) {
            return list.filter(a => {
                if (!a.poster_path) return false;
                if (a.original_language !== 'ja') return false; // Must be JP
                if (a.origin_country && !a.origin_country.includes('JP')) return false; // Must be JP Country
                return true;
            });
        }

        async function loadHome() {
            checkLogin();
            loadHistory();
            loadSchedule();

            // Slider
            const sliderRes = await fetch(`${BASE}/discover/tv?api_key=${API_KEY}&with_genres=16&with_original_language=ja&sort_by=vote_count.desc`);
            const sliderData = await sliderRes.json();
            const slider = document.getElementById('heroSlider');
            const safeSlider = strictAnimeFilter(sliderData.results);

            safeSlider.slice(0, 5).forEach((a, idx) => {
                slider.innerHTML += `
                    <div class="slide ${idx===0?'active':''}" id="slide-${idx}" style="background-image:url('https://image.tmdb.org/t/p/original${a.backdrop_path}')">
                        <div class="slide-content">
                            <div class="slide-title">${a.name}</div>
                            <button class="watch-btn" onclick="openAniWatch('${cleanTitle(a.name)}', ${a.id}, '${a.poster_path}')">WATCH NOW</button>
                        </div>
                    </div>`;
            });
            startSlider(5);

            // Categories
            const area = document.getElementById('categoriesArea');
            for (const g of genres) {
                const res = await fetch(`${BASE}/discover/tv?api_key=${API_KEY}&with_genres=16&with_original_language=ja${g.url}&page=1`);
                const data = await res.json();
                const safeList = strictAnimeFilter(data.results);

                if (safeList.length > 0) {
                    let html = `
                        <div class="section">
                            <div class="sec-head">
                                <div class="sec-title">${g.title}</div>
                                <div class="see-all" onclick="openSeeAll('${g.url}', '${g.title}')">SEE ALL</div>
                            </div>
                            <div class="row">`;
                    
                    safeList.forEach(a => {
                        html += `<div class="card" onclick="openAniWatch('${cleanTitle(a.name)}', ${a.id}, '${a.poster_path}')">
                                    <img src="https://image.tmdb.org/t/p/w300${a.poster_path}">
                                 </div>`;
                    });
                    html += `</div></div>`;
                    area.innerHTML += html;
                }
            }
        }

        function startSlider(total) {
            let idx = 0;
            setInterval(() => {
                document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
                idx = (idx + 1) % total;
                document.getElementById(`slide-${idx}`).classList.add('active');
            }, 3000);
        }

        // --- SEE ALL & INFINITE ---
        function openSeeAll(url, title) {
            document.getElementById('homeView').style.display = 'none';
            document.getElementById('seeAllView').style.display = 'block';
            document.getElementById('viewTitle').innerText = title;
            document.getElementById('infiniteGrid').innerHTML = '';
            currentUrl = url;
            currentPage = 1;
            loadNextPage();
        }

        async function loadNextPage() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('loadingIndicator').style.display = 'block';

            let fetchUrl = currentUrl.includes('query=') 
                ? `${BASE}/search/tv?api_key=${API_KEY}${currentUrl}&page=${currentPage}`
                : `${BASE}/discover/tv?api_key=${API_KEY}&with_genres=16&with_original_language=ja${currentUrl}&page=${currentPage}`;

            try {
                const res = await fetch(fetchUrl);
                const data = await res.json();
                const grid = document.getElementById('infiniteGrid');
                const safeList = strictAnimeFilter(data.results);

                safeList.forEach(a => {
                    grid.innerHTML += `<div class="card" onclick="openAniWatch('${cleanTitle(a.name)}', ${a.id}, '${a.poster_path}')">
                                        <img src="https://image.tmdb.org/t/p/w300${a.poster_path}">
                                       </div>`;
                });
                currentPage++;
            } catch (e) { console.log("End"); }
            
            isLoading = false;
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        window.addEventListener('scroll', () => {
            if(document.getElementById('seeAllView').style.display === 'block') {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                    loadNextPage();
                }
            }
        });

        function goHome() {
            document.getElementById('seeAllView').style.display = 'none';
            document.getElementById('homeView').style.display = 'block';
        }

        function doSearch() {
            const q = document.getElementById('searchInput').value;
            openSeeAll(`&query=${q}`, `Search: ${q}`);
        }

        function cleanTitle(name) {
            return name.split(':')[0].split('(')[0].replace(/Season \d+/gi, '').trim().replace(/'/g, "\\'");
        }

        // ðŸ”¥ PLAYER & HISTORY SAVE
        function openAniWatch(name, id, poster) {
            // Save to history
            if(id && poster) addToHistory({ id: id, name: name, poster_path: poster });

            let searchKeyword = name.split(" ").slice(0, 3).join(" ");
            const encodedName = encodeURIComponent(searchKeyword);
            const url = `https://aniwatchtv.to/search?keyword=${encodedName}`;
            
            document.getElementById('playerModal').style.display = 'flex';
            document.getElementById('iframe').src = url;
        }

        function closePlayer() {
            document.getElementById('playerModal').style.display = 'none';
            document.getElementById('iframe').src = '';
            loadHistory(); // Refresh history view
        }

        loadHome();
    </script>
</body>
</html>
